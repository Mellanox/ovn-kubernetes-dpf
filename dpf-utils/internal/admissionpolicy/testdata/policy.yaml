---
# Source: ovn-kubernetes-chart/templates/mutating-admission-policy.yaml
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: test-release-ovn-kubernetes-resource-injector
  labels:
    helm.sh/chart: ovn-kubernetes-chart-1.1.0
    app.kubernetes.io/name: ovn-kubernetes
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/version: "1.1.0"
    app.kubernetes.io/managed-by: Helm
spec:
  matchConstraints:
    resourceRules:
    - apiGroups: [""]
      apiVersions: ["v1"]
      operations: ["CREATE"]
      resources: ["pods"]
  matchConditions:
  - name: "exclude-hostnetwork-pods"
    expression: "!has(object.spec.hostNetwork) || object.spec.hostNetwork == false"
  - name: "exclude-skip-annotation"
    expression: '!has(object.metadata.annotations) || !("ovn.dpu.nvidia.com/skip-injection" in object.metadata.annotations)'
  mutations:
  - patchType: "ApplyConfiguration"
    applyConfiguration:
      expression: |
        Object{
          metadata: Object.metadata{
            annotations: {
              "v1.multus-cni.io/default-network": "test-namespace/dpf-ovn-kubernetes"
            }
          }
        }
  - patchType: "ApplyConfiguration"
    applyConfiguration:
      expression: |
        Object{
          spec: Object.spec{
            containers: [
              Object.spec.containers{
                name: object.spec.containers[0].name,
                resources: Object.spec.containers.resources{
                  requests: {
                    "nvidia.com/bf3-p0-vfs": string(
                      int(
                        has(object.spec.containers[0].resources) &&
                        has(object.spec.containers[0].resources.requests) && 
                        "nvidia.com/bf3-p0-vfs" in object.spec.containers[0].resources.requests
                        ? object.spec.containers[0].resources.requests["nvidia.com/bf3-p0-vfs"]
                        : "0"
                      ) + 1
                    )
                  },
                  limits: {
                    "nvidia.com/bf3-p0-vfs": string(
                      int(
                        has(object.spec.containers[0].resources) &&
                        has(object.spec.containers[0].resources.limits) && 
                        "nvidia.com/bf3-p0-vfs" in object.spec.containers[0].resources.limits
                        ? object.spec.containers[0].resources.limits["nvidia.com/bf3-p0-vfs"]
                        : "0"
                      ) + 1
                    )
                  }
                }
              }
            ]
          }
        }
  reinvocationPolicy: Never
  failurePolicy: Fail
---
# Source: ovn-kubernetes-chart/templates/mutating-admission-policy-binding.yaml
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: test-release-ovn-kubernetes-resource-injector-binding
  labels:
    helm.sh/chart: ovn-kubernetes-chart-1.1.0
    app.kubernetes.io/name: ovn-kubernetes
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/version: "1.1.0"
    app.kubernetes.io/managed-by: Helm
spec:
  policyName: test-release-ovn-kubernetes-resource-injector
